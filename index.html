<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Checklist Pro - Quản trị Mục tiêu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f0f2f5; font-size: 14px; }
        .sales-checklist-dashboard { position: sticky; top: 20px; }
        .sales-checklist-status-select { font-weight: bold; }
        .sales-checklist-status-not-started { color: #dc3545; border-color: #dc3545; }
        .sales-checklist-status-in-progress { color: #ffc107; border-color: #ffc107; }
        .sales-checklist-status-completed { color: #198754; border-color: #198754; }
        
        /* === Style cho Báo cáo PDF === */
        #sales-checklist-reportModal .modal-body { 
            background-color: #fff; 
            padding: 25px; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .report-header { text-align: center; margin-bottom: 25px; border-bottom: 3px solid #0d6efd; padding-bottom: 15px; }
        .report-title { color: #0d6efd; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .report-sub-info { color: #6c757d; font-style: italic; }
        .report-section-header { 
            background-color: #e7f1ff; 
            color: #0d6efd; 
            padding: 8px 12px; 
            font-weight: bold; 
            margin-top: 20px; 
            border-left: 5px solid #0d6efd;
            text-transform: uppercase;
            font-size: 15px;
        }

        .sales-checklist-floating-btn {
            background-color: #0d6efd;
            color: white;
            border: 2px solid white;
            border-radius: 25px;
            padding: 10px 15px;
            font-weight: bold;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
        }
        .sales-checklist-floating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.5);
        }
        .sales-checklist-floating-btn i {
            margin-right: 8px;
            font-size: 1.3rem;
        }
        #sales-checklist-floatingBtn {
            background-color: #198754;
        }
        #sales-checklist-mainAppModal .modal-dialog { max-width: 95vw; width: 1600px; }
        #sales-checklist-mainAppModal .modal-content { height: 90vh; }
        #sales-checklist-mainAppModal .modal-body { overflow-y: auto; background-color: #f8f9fa; }
        .sales-checklist-header-section {
            background-color: #0d6efd; color: white; padding: 1rem;
            border-radius: 0.5rem; margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .sales-checklist-task-card {
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 0.5rem;
        }
        .sales-checklist-task-card .card-header { font-weight: bold; font-size: 1.2rem; }
        .sales-checklist-notes-input { width: 100%; border: 1px solid #eee; padding: 5px; border-radius: 4px; }
        .sales-checklist-delete-btn { opacity: 0.5; transition: opacity 0.2s; }
        .list-group-item:hover .sales-checklist-delete-btn { opacity: 1; }
        .btn-loading .spinner-border { width: 1rem; height: 1rem; }
        .container {
            padding-top: 5rem;
            padding-bottom: 5rem;
        }
        .text-primary {
            color: #0d6efd !important;
        }
        .rounded {
            border-radius: 0.5rem !important;
        }
        .shadow {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        }
        /* === Style cho lỗi ghi chú === */
        .sales-checklist-notes-input.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        .invalid-feedback {
            display: none;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
        /* === Style cho chỉnh sửa nội dung checklist === */
        .sales-checklist-task-name {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .sales-checklist-task-name:hover {
            background-color: #f8f9fa;
        }
        .sales-checklist-task-name.editing {
            background-color: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .sales-checklist-task-name-input {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
        }
        .sales-checklist-part-header {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0d6efd;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #0d6efd;
        }

        /* === STYLE CHO PLANNER POPUP === */
        #sales-checklist-plannerModal .modal-dialog { max-width: 98vw; margin: 1vw auto; }
        #sales-checklist-plannerModal .modal-content { height: 96vh; }
        #sales-checklist-plannerModal .modal-body { overflow-y: auto; background-color: #f0f2f5; padding: 10px; }
        .planner-day-container {
            background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden;
        }
        .planner-day-header {
            background-color: #0d6efd; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .planner-day-title { font-weight: bold; font-size: 1.1rem; margin: 0; }
        .planner-table input.form-control { border: none; border-radius: 0; background: transparent; }
        .planner-table input.form-control:focus { box-shadow: none; background: #fff; }
        
        .planner-row-done { background-color: #ffebee !important; color: #c62828; }
        .planner-row-done input { color: #c62828 !important; text-decoration: line-through; }

        /* === STYLE MỚI: MỤC TIÊU CÔNG VIỆC === */
        .planner-objective-box {
            background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px; margin-bottom: 20px;
        }
        .planner-objective-label { font-weight: bold; color: #0d47a1; margin-bottom: 5px; display: block; }
        .planner-objective-input {
            width: 100%; border: 1px solid #bbdefb; border-radius: 4px; padding: 8px; font-size: 1.1rem; color: #0d47a1;
        }
        .planner-objective-input:focus { outline: none; border-color: #2196f3; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1); }

        /* === CẢNH BÁO THÔNG MINH === */
        #smart-alert-container {
            display: none; background-color: #dc3545; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4); animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .smart-alert-title { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; }
        .smart-alert-list { margin-top: 10px; margin-bottom: 0; padding-left: 20px; }
        .smart-alert-list li { font-weight: 500; font-size: 1.1rem; }
        
        .task-overdue-badge {
            background-color: #dc3545; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 12px;
            margin-left: 10px; font-weight: bold; animation: blink 1.5s infinite; display: inline-flex; align-items: center;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container text-center py-5">
        <h1 class="mb-4 text-primary">BÁM SÁT MỤC TIÊU, BỨT PHÁ DOANH THU!</h1>
        <div class="d-flex justify-content-center">
            <img src="https://cdn.imgpile.com/f/im0vJIV_xl.png" alt="Giao diện đẹp" class="img-fluid rounded shadow" style="max-width: 80%; height: auto;">
        </div>
    </div>
    <div style="position: fixed; top: 60px; left: 20px; z-index: 1040; display: flex; flex-direction: column; gap: 10px;">
        <a href="https://erp-ideco.skyit.vn/#/app/dashboard/main" style="text-decoration: none;">
            <button id="sales-checklist-erpBtn" class="sales-checklist-floating-btn">
                <i class="bi bi-house-door-fill"></i> ERP HOME
            </button>
        </a>
        <button id="sales-checklist-floatingBtn" class="sales-checklist-floating-btn" data-bs-toggle="modal" data-bs-target="#sales-checklist-selectionModal">
            <i class="bi bi-card-checklist"></i> Kinh doanh Checklist
        </button>
    </div>

    <div class="modal fade" id="sales-checklist-selectionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-check-fill"></i> Chọn Checklist Nhân viên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Chọn checklist đã có hoặc tạo mới.</p>
                    <div id="sales-checklist-employeeList" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success" onclick="openNewEmployeeModal()">
                        <i class="bi bi-plus-circle"></i> Tạo Checklist Mới
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sales-checklist-mainAppModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                 <div class="modal-header bg-light">
                    <h5 class="modal-title text-primary" id="sales-checklist-mainAppModalLabel"></h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm me-auto ms-4" onclick="backToSelection()">
                        <i class="bi bi-arrow-left-right"></i> Quay lại Bảng Chọn
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="header-section sales-checklist-header-section text-center">
                            <h2><i class="bi bi-card-checklist"></i> BẢNG CHECKLIST CÔNG VIỆC KINH DOANH THÁNG</h2>
                            <h5 id="sales-checklist-currentMonth"></h5>
                        </div>

                        <div id="smart-alert-container">
                            <div class="smart-alert-title">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i> 
                                CẢNH BÁO: PHÁT HIỆN CÔNG VIỆC TRONG KẾ HOẠCH BỊ TRỄ HẠN!
                            </div>
                            <ul id="smart-alert-list" class="smart-alert-list">
                                </ul>
                            <div class="mt-2 text-end">
                                <small style="font-style: italic;">(Các mục này sẽ BỊ KHÓA trạng thái Hoàn thành cho đến khi bạn xử lý xong trong Kế hoạch chi tiết)</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-3">
                                <div class="card sales-checklist-dashboard">
                                    <div class="card-header bg-dark text-white"><i class="bi bi-speedometer2"></i> Bảng Điều Khiển</div>
                                    <div class="card-body">
                                        <h5>Tổng Quan Tiến Độ</h5>
                                        <div class="progress" style="height: 30px;"><div id="sales-checklist-totalProgressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width: 0%; font-size: 1rem;">0%</div></div>
                                        <hr>
                                        <div id="sales-checklist-summary">
                                            <p class="mb-1"><strong>Tổng số công việc:</strong> <span id="sales-checklist-totalTasks">0</span></p>
                                            <p class="mb-1 text-success"><strong><i class="bi bi-check-circle-fill"></i> Hoàn thành:</strong> <span id="sales-checklist-completedTasks">0</span></p>
                                            <p class="mb-1 text-warning"><strong><i class="bi bi-play-circle-fill"></i> Đang làm:</strong> <span id="sales-checklist-inProgressTasks">0</span></p>
                                            <p class="mb-1 text-danger"><strong><i class="bi bi-x-circle-fill"></i> Chưa làm:</strong> <span id="sales-checklist-notStartedTasks">0</span></p>
                                        </div>
                                        <hr>
                                        <div class="d-grid">
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sales-checklist-reportModal"><i class="bi bi-file-earmark-pdf"></i> Xuất Báo Cáo PDF</button>
                                        </div>
                                        <div class="d-grid mt-3">
                                            <button class="btn btn-warning" onclick="confirmRefreshChecklist()"><i class="bi bi-arrow-clockwise"></i> Làm mới kỳ mới</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-9">
                                <div id="sales-checklist-taskList"></div>
                                <div class="d-flex justify-content-end mt-3">
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#sales-checklist-addTaskModal"><i class="bi bi-plus-circle"></i> Thêm Công Việc Mới</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sales-checklist-plannerModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-calendar-week"></i> KẾ HOẠCH CHI TIẾT TUẦN - <span id="planner-task-title-display" style="font-weight:bold; color: #fff; text-transform: uppercase;"></span></h5>
                    <button type="button" class="btn-close btn-close-white" onclick="closePlannerModal()"></button>
                </div>
                <div class="modal-body" id="planner-body-content">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePlannerModal()">Quay lại Checklist</button>
                    <button type="button" class="btn btn-primary" onclick="savePlannerData()"><i class="bi bi-save"></i> Lưu Kế Hoạch</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sales-checklist-newEmployeeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Tạo Checklist Mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <label for="sales-checklist-newEmployeeNameInput" class="form-label">Nhập tên Nhân viên Kinh doanh:</label>
                    <input type="text" id="sales-checklist-newEmployeeNameInput" class="form-control" placeholder="Ví dụ: Trần Văn An">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" id="sales-checklist-saveNewEmployeeBtn" class="btn btn-primary" onclick="createNewChecklist()">Lưu và Bắt đầu</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sales-checklist-addTaskModal" tabindex="-1" aria-labelledby="sales-checklist-addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="sales-checklist-addTaskModalLabel">Thêm Công Việc Mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="sales-checklist-addTaskForm">
                        <div class="mb-3"><label for="sales-checklist-taskName" class="form-label">Tên công việc</label><input type="text" class="form-control" id="sales-checklist-taskName" required></div>
                        <div class="mb-3">
                            <label for="sales-checklist-taskCategory" class="form-label">Phân loại</label>
                            <select class="form-select" id="sales-checklist-taskCategory" required>
                                <option value="Quản lý & Chăm sóc KH Hiện tại">Quản lý & Chăm sóc KH Hiện tại</option>
                                <option value="Phát triển Khách hàng Mới">Phát triển Khách hàng Mới</option>
                                <option value="Điều phối Đơn hàng & Vận hành">Điều phối Đơn hàng & Vận hành</option>
                                <option value="Báo cáo & Công việc Khác">Báo cáo & Công việc Khác</option>
                            </select>
                        </div>
                        <div class="mb-3"><label for="sales-checklist-taskDeadline" class="form-label">Hạn chót (Tùy chọn)</label><input type="date" class="form-control" id="sales-checklist-taskDeadline"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="addTask()">Thêm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sales-checklist-reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xem trước Báo Cáo PDF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="sales-checklist-reportContent">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" onclick="exportToPDF()">
                        <i class="bi bi-file-earmark-pdf-fill"></i> Tải về PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyBioyt4trx5__rZkeo8rgE8I6OWR06lqiw",
        authDomain: "kdchecklist.firebaseapp.com",
        projectId: "kdchecklist",
        storageBucket: "kdchecklist.firebasestorage.app",
        messagingSenderId: "364070659551",
        appId: "1:364070659551:web:e193f55051e9f48265906a",
        measurementId: "G-KG196ZMX96"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    let currentEmployeeId = null;
    let currentChecklistData = null;
    let selectionModal, mainAppModal, newEmployeeModal, addTaskModal, plannerModal;
    
    // --- VARIABLES CHO PLANNER ---
    let currentPlannerTaskId = null;
    let currentPlannerData = {};
    const PLANNER_DAYS = ["Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6", "Thứ 7", "Chủ Nhật"];
    const DAY_INDEX_MAP = {
        "Thứ 2": 1, "Thứ 3": 2, "Thứ 4": 3, "Thứ 5": 4, 
        "Thứ 6": 5, "Thứ 7": 6, "Chủ Nhật": 7
    };

    // === Định nghĩa placeholder theo loại công việc ===
    const NOTE_PLACEHOLDERS = {
        'Quản lý & Chăm sóc KH Hiện tại': 'Doanh số - tổng số khách hàng đặt- việc đã xử lý thế nào',
        'Phát triển Khách hàng Mới': 'Đã phát triển bao nhiêu khách hàng ; khai báo giao dịch thế nào; có lấy đơn?',
        'Điều phối Đơn hàng & Vận hành': 'Các nội dung xử lý đơn hàng- điều phối hàng- chứng từ- thu hồi nợ - giao dịch',
        'Báo cáo & Công việc Khác': 'Đã xừ lý phát thế nào - phối hợp - nghiệm thu ra sao'
    };

    const initialTasks = [
        // Quản lý & Chăm sóc KH Hiện tại
        { id: 1, category: 'Quản lý & Chăm sóc KH Hiện tại', name: 'Thực hiện xử lý -kiểm tra khách hàng đặt hàng nhóm Dược mỹ phẩm UVS -Dầu gội', status: 'not-started', notes: '', deadline: '' },
        { id: 2, category: 'Quản lý & Chăm sóc KH Hiện tại', name: 'Thực hiện xử lý -kiểm tra khách hàng đặt hàng nhóm Thuốc', status: 'not-started', notes: '', deadline: '' },
        { id: 3, category: 'Quản lý & Chăm sóc KH Hiện tại', name: 'Thực hiện triển khai giới thiệu thuốc mới/sản phẩm mới/gởi CTKM dến khách hàng', status: 'not-started', notes: '', deadline: '' },
        { id: 4, category: 'Quản lý & Chăm sóc KH Hiện tại', name: 'Thực hiện xử lý thủ tục khách hàng đổi tra sản phẩm - trao đổi nội bộ', status: 'not-started', notes: 'Phối hợp với kế toán', deadline: '' },
        { id: 5, category: 'Quản lý & Chăm sóc KH Hiện tại', name: 'Thực hiện kiểm tra công nợ -xử lý công nợ đến hạn/quá hạn trong kỳ', status: 'not-started', notes: '', deadline: '' },
        { id: 6, category: 'Quản lý & Chăm sóc KH Hiện tại', name: 'Thực hiện đối chiếu hàng- xử lý đơn hàng cho chuỗi NT ( nếu có)', status: 'not-started', notes: '', deadline: '' },
        // Phát triển Khách hàng Mới
        { id: 7, category: 'Phát triển Khách hàng Mới', name: 'Thực hiện mục tiêu/kế hoạch phát triển khách hàng nhóm UVS- Dầu gội phủ bạc', status: 'not-started', notes: '', deadline: '' },
        { id: 8, category: 'Phát triển Khách hàng Mới', name: 'Thực hiện mục tiêu/kế hoạch phát triển khách hàng nhóm thuốc', status: 'not-started', notes: 'Mục tiêu: 5 KH mới/tuần', deadline: '' },
        { id: 9, category: 'Phát triển Khách hàng Mới', name: 'Thực hiện kiểm tra- cập nhật lại báo cáo giao dịch theo phát sinh mới', status: 'not-started', notes: '', deadline: '' },
        { id: 10, category: 'Phát triển Khách hàng Mới', name: 'Gửi báo giá, đàm phán, thương lượng hợp đồng', status: 'not-started', notes: '', deadline: '' },
        { id: 11, category: 'Phát triển Khách hàng Mới', name:'Hoàn tất thủ tục mở khách hàng mới trên hệ thống', status: 'not-started', notes: '', deadline: '' },
        // Điều phối Đơn hàng & Vận hành
        { id: 12, category: 'Điều phối Đơn hàng & Vận hành', name: 'Xử lý - đối soát các nội dung cung cấp thông tin, chứng từ cho khách hàng', status: 'not-started', notes: '', deadline: '' },
        { id: 13, category: 'Điều phối Đơn hàng & Vận hành', name: 'Cập nhật lại các dữ liệu lên ứng dụng trong kỳ: khách hàng đặt hàng / chuôi NT ( nếu có)', status: 'not-started', notes: '', deadline: '' },
        { id: 14, category: 'Điều phối Đơn hàng & Vận hành', name: 'Xử lý các thủ tục phát sinh liên quan đến chứng từ/ tài liệu/hàng hóa nội bộ ', status: 'not-started', notes: 'Đảm bảo tuân thủ GDP, SOP', deadline: '' },
        { id: 15, category: 'Điều phối Đơn hàng & Vận hành', name: 'Theo dõi tiến trình giao hàng và xác nhận với khách hàng/ đổi trả hàng phát sinh', status: 'not-started', notes: '', deadline: '' },
        { id: 16, category: 'Điều phối Đơn hàng & Vận hành', name: 'Xử lý thông tin báo giá/văn bản thông báo giá/ in lưu chứng từ công việc trong tuần', status: 'not-started', notes: '', deadline: '' },
        // Báo cáo & Công việc Khác
        { id: 17, category: 'Báo cáo & Công việc Khác', name: 'Ra sót kế hoạch - bấm hoàn thành- báo cáo nội dung lưu chuyển báo cáo', status: 'not-started', notes: '', deadline: '' },
        { id: 18, category: 'Báo cáo & Công việc Khác', name: 'Ra soát cập nhật báo cáo giao dịch khách hàng cho đúng khai báo', status: 'not-started', notes: 'Hạn cuối: ngày 2 của tháng sau', deadline: '' },
        { id: 19, category: 'Báo cáo & Công việc Khác', name: 'Báo cáo KPI tháng - đối chiếu kết quả cuối kỳ nội bộ', status: 'not-started', notes: '', deadline: '' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        selectionModal = new bootstrap.Modal(document.getElementById('sales-checklist-selectionModal'));
        mainAppModal = new bootstrap.Modal(document.getElementById('sales-checklist-mainAppModal'));
        newEmployeeModal = new bootstrap.Modal(document.getElementById('sales-checklist-newEmployeeModal'));
        addTaskModal = new bootstrap.Modal(document.getElementById('sales-checklist-addTaskModal'));
        plannerModal = new bootstrap.Modal(document.getElementById('sales-checklist-plannerModal'));
        document.getElementById('sales-checklist-selectionModal').addEventListener('shown.bs.modal', loadEmployeeList);
    });

    // === QUẢN LÝ KẾ HOẠCH TUẦN & LOGIC THÔNG MINH ===
    function openPlanner(taskId) {
        currentPlannerTaskId = taskId;
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (!task) return;

        currentPlannerData = task.weeklyPlan ? JSON.parse(JSON.stringify(task.weeklyPlan)) : {};
        if (!currentPlannerData.objective) currentPlannerData.objective = '';

        PLANNER_DAYS.forEach(day => {
            if (!currentPlannerData[day]) currentPlannerData[day] = [];
        });

        document.getElementById('planner-task-title-display').innerText = task.name;
        renderPlannerUI();
        plannerModal.show();
    }

    function renderPlannerUI() {
        const container = document.getElementById('planner-body-content');
        container.innerHTML = '';

        // 1. RENDER MỤC TIÊU
        const objectiveDiv = document.createElement('div');
        objectiveDiv.className = 'planner-objective-box';
        objectiveDiv.innerHTML = `
            <label class="planner-objective-label"><i class="bi bi-bullseye"></i> MỤC TIÊU / KẾT QUẢ THEN CHỐT CỦA CÔNG VIỆC:</label>
            <input type="text" class="planner-objective-input" 
                   value="${currentPlannerData.objective || ''}" 
                   placeholder="Ví dụ: Đạt doanh số 50 triệu tuần này..." 
                   onchange="updatePlannerObjective(this.value)">
        `;
        container.appendChild(objectiveDiv);

        // 2. RENDER CÁC NGÀY
        PLANNER_DAYS.forEach(day => {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'planner-day-container';
            
            let tableRows = '';
            currentPlannerData[day].forEach((item, index) => {
                const rowClass = item.isDone ? 'planner-row-done' : '';
                const btnClass = item.isDone ? 'btn-danger' : 'btn-outline-success';
                const btnIcon = item.isDone ? '<i class="bi bi-x-circle"></i> Đóng' : '<i class="bi bi-check2-circle"></i> Xong';
                
                tableRows += `
                    <tr class="${rowClass}">
                        <td style="width: 30%"><input type="text" class="form-control" value="${item.content || ''}" onchange="updatePlannerItem('${day}', ${index}, 'content', this.value)" placeholder="Nội dung công việc..."></td>
                        <td style="width: 15%"><input type="date" class="form-control" value="${item.start || ''}" onchange="updatePlannerItem('${day}', ${index}, 'start', this.value)"></td>
                        <td style="width: 15%"><input type="date" class="form-control" value="${item.end || ''}" onchange="updatePlannerItem('${day}', ${index}, 'end', this.value)"></td>
                        <td style="width: 25%"><input type="text" class="form-control" value="${item.result || ''}" onchange="updatePlannerItem('${day}', ${index}, 'result', this.value)" placeholder="Kết quả..."></td>
                        <td style="width: 15%" class="text-end">
                            <button class="btn btn-sm ${btnClass} me-1" onclick="togglePlannerItemDone('${day}', ${index})">${btnIcon}</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="deletePlannerItem('${day}', ${index})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            dayDiv.innerHTML = `
                <div class="planner-day-header">
                    <h5 class="planner-day-title">${day}</h5>
                    <button class="btn btn-sm btn-light text-primary fw-bold" onclick="addPlannerItem('${day}')"><i class="bi bi-plus-lg"></i> Thêm việc</button>
                </div>
                <div class="p-2">
                    <table class="table table-borderless planner-table mb-0 align-middle">
                        <thead>
                            <tr class="text-muted border-bottom" style="font-size: 0.85rem;">
                                <th>Công việc</th>
                                <th>Ngày BĐ</th>
                                <th>Ngày KT</th>
                                <th>Kết quả</th>
                                <th class="text-end">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    ${currentPlannerData[day].length === 0 ? '<div class="text-center text-muted fst-italic py-3">Chưa có kế hoạch cho ngày này</div>' : ''}
                </div>
            `;
            container.appendChild(dayDiv);
        });
    }

    function updatePlannerObjective(value) { currentPlannerData.objective = value; }
    function addPlannerItem(day) { currentPlannerData[day].push({ content: '', start: '', end: '', result: '', isDone: false }); renderPlannerUI(); }
    function deletePlannerItem(day, index) { if(confirm('Xóa dòng kế hoạch này?')) { currentPlannerData[day].splice(index, 1); renderPlannerUI(); } }
    function togglePlannerItemDone(day, index) { currentPlannerData[day][index].isDone = !currentPlannerData[day][index].isDone; renderPlannerUI(); }
    function updatePlannerItem(day, index, field, value) { currentPlannerData[day][index][field] = value; }

    function savePlannerData() {
        if (!currentPlannerTaskId) return;
        const task = currentChecklistData.tasks.find(t => t.id === currentPlannerTaskId);
        if (task) {
            task.weeklyPlan = currentPlannerData;
            saveTasks();
            alert('Đã lưu kế hoạch tuần!');
            checkDailyProgress();
            renderTasks(currentChecklistData.tasks);
        }
    }
    function closePlannerModal() { if(confirm('Các thay đổi chưa lưu sẽ bị mất. Bạn có chắc muốn đóng?')) { plannerModal.hide(); } }

    // === LOGIC KIỂM TRA TRỄ HẠN THÔNG MINH ===
    function getCurrentDayIndex() { const d = new Date(); const day = d.getDay(); return day === 0 ? 7 : day; }

    function isTaskOverdue(task) {
        if (!task.weeklyPlan) return false;
        const currentIdx = getCurrentDayIndex();
        
        for (const [dayName, items] of Object.entries(task.weeklyPlan)) {
            if (dayName === 'objective') continue;
            const dayIdx = DAY_INDEX_MAP[dayName];
            
            // Chỉ kiểm tra các ngày trong quá khứ
            if (dayIdx < currentIdx) {
                if (items && Array.isArray(items)) {
                    // Trễ hạn nếu: Có nội dung VÀ có ngày BĐ/KT VÀ chưa xong
                    const hasOverdueItem = items.some(item => {
                        const isConfigured = item.content && item.content.trim() !== '' && item.start && item.end;
                        return isConfigured && !item.isDone;
                    });
                    if (hasOverdueItem) return true;
                }
            }
        }
        return false;
    }

    function checkDailyProgress() {
        if (!currentChecklistData) return;
        const alertContainer = document.getElementById('smart-alert-container');
        const alertList = document.getElementById('smart-alert-list');
        let unfinishedTasks = [];

        currentChecklistData.tasks.forEach(task => {
            if (isTaskOverdue(task)) { unfinishedTasks.push(task.name); }
        });

        if (unfinishedTasks.length > 0) {
            alertList.innerHTML = '';
            unfinishedTasks.forEach(name => {
                const li = document.createElement('li'); li.innerText = name; alertList.appendChild(li);
            });
            alertContainer.style.display = 'block'; 
        } else {
            alertContainer.style.display = 'none'; 
        }
    }

    // === CẬP NHẬT: Hàm updateStatus có kiểm tra KHÓA TRẠNG THÁI ===
    function updateStatus(taskId, status, selectElement) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (!task) return;

        // KIỂM TRA 1: KHÓA TRẠNG THÁI NẾU TRỄ HẠN PLANNER
        if (status === 'completed' && isTaskOverdue(task)) {
            alert('CẢNH BÁO QUẢN TRỊ:\n\nCông việc này đang có hạng mục trong Kế hoạch chi tiết bị TRỄ HẠN.\n\nVui lòng vào "Lập KH" để xử lý dứt điểm trước khi báo cáo hoàn thành.');
            selectElement.value = task.status;
            return;
        }

        // KIỂM TRA 2: ĐỘ DÀI GHI CHÚ
        if (status === 'completed') {
            const noteLength = (task.notes || '').trim().length;
            if (noteLength < 20) {
                selectElement.value = task.status;
                const noteTextarea = document.querySelector(`textarea[onchange*="updateNotes(${taskId},"]`);
                if (noteTextarea) {
                    noteTextarea.classList.add('is-invalid');
                    let errorEl = noteTextarea.parentElement.querySelector('.invalid-feedback');
                    if (!errorEl) {
                        errorEl = document.createElement('div');
                        errorEl.className = 'invalid-feedback';
                        errorEl.style.display = 'block';
                        noteTextarea.parentElement.appendChild(errorEl);
                    }
                    errorEl.textContent = 'Viết ngắn gọn - đầy đủ nội dung hoàn thành ít nhất 20 ký tự.';
                    noteTextarea.focus();
                }
                return;
            } else {
                const noteTextarea = document.querySelector(`textarea[onchange*="updateNotes(${taskId},"]`);
                if (noteTextarea) {
                    noteTextarea.classList.remove('is-invalid');
                    const errorEl = noteTextarea.parentElement.querySelector('.invalid-feedback');
                    if (errorEl) errorEl.remove();
                }
            }
        }

        task.status = status;
        updateSelectColor(selectElement, status);
        updateDashboard();
        saveTasks();
    }

    function updateNotes(taskId, notes) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (task) { task.notes = notes; saveTasks(); }
    }

    function updateDeadline(taskId, deadline) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (task) { task.deadline = deadline; saveTasks(); }
    }

    function editTaskName(taskId) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (!task) return;
        const taskElement = document.querySelector(`[data-task-id="${taskId}"] .sales-checklist-task-name`);
        if (!taskElement) return;
        
        const input = document.createElement('input');
        input.type = 'text'; input.className = 'sales-checklist-task-name-input'; input.value = task.name;
        
        taskElement.classList.add('editing'); taskElement.innerHTML = ''; taskElement.appendChild(input); input.focus();
        
        const finishEdit = () => {
            const newName = input.value.trim();
            if (newName && newName !== task.name) { updateTaskName(taskId, newName); } 
            else { taskElement.textContent = task.name; }
            taskElement.classList.remove('editing');
        };
        input.addEventListener('blur', finishEdit);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') finishEdit(); });
    }

    function updateTaskName(taskId, newName) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (task) { 
            task.name = newName; 
            saveTasks();
            renderTasks(currentChecklistData.tasks);
        }
    }

    function deleteTask(taskId) {
        if (confirm('Bạn có chắc chắn muốn xóa công việc này?')) {
            const taskIndex = currentChecklistData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                currentChecklistData.tasks.splice(taskIndex, 1);
                saveTasks();
                renderTasks(currentChecklistData.tasks);
            }
        }
    }

    async function saveTasks() {
        if (!currentEmployeeId) return;
        try {
            await database.ref(`sales-checklists/${currentEmployeeId}/tasks`).set(currentChecklistData.tasks);
        } catch (error) {
            console.error("Lỗi khi lưu:", error);
            alert("Không thể lưu thay đổi.");
        }
    }

    function renderTasks(tasks) {
        const now = new Date();
        document.getElementById('sales-checklist-currentMonth').innerText = `KỲ BÁO CÁO: THÁNG ${now.getMonth() + 1} NĂM ${now.getFullYear()}`;
        const taskListDiv = document.getElementById('sales-checklist-taskList');
        taskListDiv.innerHTML = '';

        const categories = [...new Set(tasks.map(task => task.category))];
        categories.forEach(category => {
            const categoryHeader = document.createElement('h2');
            categoryHeader.className = 'sales-checklist-part-header';
            let iconClass = 'bi-briefcase';
            if (category.includes('Hiện tại')) iconClass = 'bi-person-check';
            if (category.includes('Mới')) iconClass = 'bi-person-plus';
            if (category.includes('Vận hành')) iconClass = 'bi-gear';
            if (category.includes('Báo cáo')) iconClass = 'bi-clipboard-data';
            categoryHeader.innerHTML = `<i class="bi ${iconClass}"></i> ${category}`;
            taskListDiv.appendChild(categoryHeader);

            const card = document.createElement('div');
            card.className = 'card sales-checklist-task-card';
            card.innerHTML = `<div class="card-header"><i class="bi ${iconClass}"></i> ${category}</div>`;
            const table = document.createElement('table');
            table.className = 'table table-hover table-striped mb-0';
            table.innerHTML = `
                <thead class="table-light">
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 35%;">Nội dung công việc</th>
                        <th style="width: 15%;">Trạng thái</th>
                        <th style="width: 10%;">Kế hoạch</th>
                        <th style="width: 10%;">Hạn chót</th>
                        <th style="width: 20%;">Ghi chú</th>
                        <th style="width: 5%;">Xóa</th>
                    </tr>
                </thead>`;
            const tbody = document.createElement('tbody');
            tasks.filter(t => t.category === category).forEach(task => {
                const placeholder = NOTE_PLACEHOLDERS[task.category] || 'Vui lòng mô tả chi tiết kết quả công việc...';
                
                // Hiển thị Badge nếu trễ hạn
                const overdueBadge = isTaskOverdue(task) 
                    ? `<span class="task-overdue-badge"><i class="bi bi-exclamation-octagon-fill"></i> CÓ VIỆC TRỄ HẠN</span>` 
                    : '';

                const tr = document.createElement('tr');
                tr.setAttribute('data-task-id', task.id);
                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>
                        <div class="sales-checklist-task-name" onclick="editTaskName(${task.id})">
                            ${task.name}
                        </div>
                        ${overdueBadge}
                    </td>
                    <td>
                        <select class="form-select form-select-sm sales-checklist-status-select" 
                                onchange="updateStatus(${task.id}, this.value, this)">
                            <option value="not-started">Chưa làm</option>
                            <option value="in-progress">Đang làm</option>
                            <option value="completed">Hoàn thành</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-dark btn-sm text-white w-100 fw-bold" onclick="openPlanner(${task.id})">
                            <i class="bi bi-calendar-check"></i> Lập KH
                        </button>
                    </td>
                    <td><input type="date" class="form-control form-control-sm" value="${task.deadline || ''}" onchange="updateDeadline(${task.id}, this.value)"></td>
                    <td>
                        <textarea class="form-control form-control-sm sales-checklist-notes-input" 
                                  rows="2" 
                                  placeholder="${placeholder}"
                                  onchange="updateNotes(${task.id}, this.value)">${task.notes || ''}</textarea>
                    </td>
                    <td>
                        <button class="btn btn-outline-danger btn-sm sales-checklist-delete-btn" onclick="deleteTask(${task.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>`;
                const select = tr.querySelector('.sales-checklist-status-select');
                select.value = task.status;
                updateSelectColor(select, task.status);
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            card.appendChild(table);
            taskListDiv.appendChild(card);
        });
        updateDashboard();
    }

    function setButtonLoading(button, isLoading) {
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Đang xử lý...`;
        } else {
            if (button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
            }
            button.disabled = false;
        }
    }

    async function loadEmployeeList() {
        const listDiv = document.getElementById('sales-checklist-employeeList');
        listDiv.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>`;
        try {
            const snapshot = await database.ref('sales-checklists').once('value');
            const data = snapshot.val();
            listDiv.innerHTML = '';
            if (data) {
                Object.values(data).forEach(emp => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <a href="#" class="text-decoration-none text-dark flex-grow-1" onclick="event.preventDefault(); loadChecklistFor('${emp.id}')">
                            <strong>${emp.employeeName}</strong>
                            <br><small class="text-muted">Ngày lập: ${emp.creationDate}</small>
                        </a>
                        <button class="btn btn-outline-danger btn-sm sales-checklist-delete-btn" onclick="confirmDeleteEmployee(this, '${emp.id}', '${emp.employeeName}')"><i class="bi bi-trash-fill"></i></button>`;
                    listDiv.appendChild(item);
                });
            } else {
                listDiv.innerHTML = '<p class="text-center text-muted p-3">Chưa có checklist nào.</p>';
            }
        } catch (error) {
            console.error("Lỗi:", error);
            listDiv.innerHTML = '<p class="text-center text-danger p-3">Lỗi kết nối CSDL.</p>';
        }
    }

    function openNewEmployeeModal() {
        document.getElementById('sales-checklist-newEmployeeNameInput').value = '';
        newEmployeeModal.show();
    }

    async function createNewChecklist() {
        const nameInput = document.getElementById('sales-checklist-newEmployeeNameInput');
        const name = nameInput.value.trim();
        const saveBtn = document.getElementById('sales-checklist-saveNewEmployeeBtn');
        if (!name) { alert('Vui lòng nhập tên.'); return; }
        setButtonLoading(saveBtn, true);
        try {
            const employeeId = slugify(name);
            const ref = database.ref('sales-checklists/' + employeeId);
            const snapshot = await ref.once('value');
            if (snapshot.exists()) {
                alert('Tên này đã tồn tại.');
                return;
            }
            const newChecklist = {
                id: employeeId, employeeName: name,
                creationDate: new Date().toLocaleDateString('vi-VN'),
                tasks: JSON.parse(JSON.stringify(initialTasks))
            };
            await ref.set(newChecklist);
            newEmployeeModal.hide();
            loadChecklistFor(employeeId);
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi tạo mới.");
        } finally {
            setButtonLoading(saveBtn, false);
        }
    }

    async function loadChecklistFor(employeeId) {
        try {
            const snapshot = await database.ref('sales-checklists/' + employeeId).once('value');
            currentChecklistData = snapshot.val();
            if (currentChecklistData) {
                currentEmployeeId = employeeId;
                document.getElementById('sales-checklist-mainAppModalLabel').innerHTML = `<i class="bi bi-person-fill"></i> Checklist của: <strong>${currentChecklistData.employeeName}</strong>`;
                renderTasks(currentChecklistData.tasks);
                selectionModal.hide();
                mainAppModal.show();
            } else {
                alert('Không tìm thấy dữ liệu.');
                loadEmployeeList();
            }
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Không thể tải dữ liệu.");
        }
    }

    function confirmDeleteEmployee(button, id, name) {
        if (confirm(`Bạn có chắc chắn muốn xóa checklist của "${name}" không?`)) {
            deleteEmployee(button, id);
        }
    }

    async function deleteEmployee(button, id) {
        setButtonLoading(button, true);
        try {
            await database.ref('sales-checklists/' + id).remove();
            loadEmployeeList();
        } catch(error) {
            console.error("Lỗi:", error);
            alert("Xóa thất bại.");
            setButtonLoading(button, false);
        }
    }

    function backToSelection() {
        mainAppModal.hide();
        selectionModal.show();
    }

    window.addTask = function() {
        const name = document.getElementById('sales-checklist-taskName').value;
        const category = document.getElementById('sales-checklist-taskCategory').value;
        const deadline = document.getElementById('sales-checklist-taskDeadline').value;
        if (name && category) {
            const newId = currentChecklistData.tasks.length > 0 ? Math.max(...currentChecklistData.tasks.map(t => t.id)) + 1 : 1;
            const newTask = {
                id: newId, category: category, name: name,
                status: 'not-started', notes: '', deadline: deadline
            };
            currentChecklistData.tasks.push(newTask);
            saveTasks();
            renderTasks(currentChecklistData.tasks);
            addTaskModal.hide();
            document.getElementById('sales-checklist-addTaskForm').reset();
        } else {
            alert('Vui lòng nhập tên công việc và chọn phân loại.');
        }
    }

    function updateDashboard() {
        if (!currentChecklistData) return;
        const tasks = currentChecklistData.tasks;
        const total = tasks.length, completed = tasks.filter(t => t.status === 'completed').length;
        const inProgress = tasks.filter(t => t.status === 'in-progress').length;
        document.getElementById('sales-checklist-totalTasks').innerText = total;
        document.getElementById('sales-checklist-completedTasks').innerText = completed;
        document.getElementById('sales-checklist-inProgressTasks').innerText = inProgress;
        document.getElementById('sales-checklist-notStartedTasks').innerText = total - completed - inProgress;
        const progressBar = document.getElementById('sales-checklist-totalProgressBar');
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        progressBar.style.width = `${percentage}%`;
        progressBar.innerText = `${percentage}%`;
        
        checkDailyProgress(); // GỌI SMART CHECK
    }

    function updateSelectColor(select, status) {
        select.className = 'form-select form-select-sm sales-checklist-status-select';
        if (status === 'not-started') select.classList.add('sales-checklist-status-not-started');
        else if (status === 'in-progress') select.classList.add('sales-checklist-status-in-progress');
        else if (status === 'completed') select.classList.add('sales-checklist-status-completed');
    }

    function slugify(str) {
        str = str.replace(/^\s+|\s+$/g, '').toLowerCase();
        const from = "àáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ·/_,:;";
        const to   = "aaaaaaaaaaaaaaaaaeeeeeeeeeeeiiiiiooooooooooooooooouuuuuuuuuuuyyyyyd------";
        for (let i = 0, l = from.length; i < l; i++) str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
        return str.replace(/[^a-z0-9 -]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
    }

    // === CHỨC NĂNG XUẤT PDF (CẬP NHẬT HIỂN THỊ MỤC TIÊU) ===
    document.getElementById('sales-checklist-reportModal').addEventListener('show.bs.modal', function () {
        if (!currentChecklistData) return;
        const { employeeName, tasks } = currentChecklistData;
        const now = new Date();
        const month = now.getMonth() + 1;
        const year = now.getFullYear();
        const total = tasks.length;
        const completed = tasks.filter(t => t.status === 'completed').length;
        const inProgress = tasks.filter(t => t.status === 'in-progress').length;
        const notStarted = total - completed - inProgress;
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

        let html = `
            <div class="report-header">
                <h3 class="report-title">BÁO CÁO CÔNG VIỆC KINH DOANH</h3>
                <p class="mb-0"><strong>Nhân viên:</strong> ${employeeName}</p>
                <p class="report-sub-info">Tháng ${month}/${year}</p>
            </div>
            
            <div class="card mb-4 border-0 shadow-sm" style="background-color: #f8f9fa;">
                <div class="card-body">
                    <h5 class="card-title text-center text-primary mb-3">TỔNG QUAN HIỆU SUẤT</h5>
                    <div class="row text-center">
                        <div class="col-3 border-end">
                            <h2 class="text-primary mb-0">${total}</h2>
                            <small class="text-muted">Tổng việc</small>
                        </div>
                        <div class="col-3 border-end">
                            <h2 class="text-success mb-0">${completed}</h2>
                            <small class="text-muted">Hoàn thành (${percentage}%)</small>
                        </div>
                        <div class="col-3 border-end">
                            <h2 class="text-warning mb-0">${inProgress}</h2>
                            <small class="text-muted">Đang làm</small>
                        </div>
                        <div class="col-3">
                            <h2 class="text-danger mb-0">${notStarted}</h2>
                            <small class="text-muted">Chưa làm</small>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="text-center text-uppercase fw-bold mt-4 mb-3" style="color: #0d6efd;">CHI TIẾT CÔNG VIỆC</h5>
        `;

        const categories = [...new Set(tasks.map(task => task.category))];
        categories.forEach(category => {
            html += `<div class="report-section-header">${category}</div>`;
            html += `
                <table class="table table-bordered table-sm mt-2" style="font-size: 13px;">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40%">Nội dung công việc</th>
                            <th style="width: 20%">Mục tiêu</th>
                            <th style="width: 15%">Trạng thái</th>
                            <th style="width: 25%">Ghi chú / Kết quả</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            const tasksInCategory = tasks.filter(t => t.category === category);
            tasksInCategory.forEach(task => {
                let statusText = '', statusClass = '';
                if (task.status === 'completed') { statusText = 'Hoàn thành'; statusClass = 'text-success fw-bold'; }
                else if (task.status === 'in-progress') { statusText = 'Đang làm'; statusClass = 'text-warning fw-bold'; }
                else { statusText = 'Chưa làm'; statusClass = 'text-secondary'; }

                let objective = '';
                if (task.weeklyPlan && task.weeklyPlan.objective) {
                    objective = `<span class="text-primary fst-italic">${task.weeklyPlan.objective}</span>`;
                }

                html += `
                    <tr>
                        <td>${task.name}</td>
                        <td>${objective}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>${task.notes || ''}</td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
        });

        document.getElementById('sales-checklist-reportContent').innerHTML = html;
    });

    window.exportToPDF = function() {
        const element = document.getElementById('sales-checklist-reportContent');
        if (!currentChecklistData) return;
        
        const opt = {
            margin:       10,
            filename:     `BaoCao_KinhDoanh_${slugify(currentChecklistData.employeeName)}_${new Date().getMonth()+1}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        const btn = document.querySelector('button[onclick="exportToPDF()"]');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang tạo PDF...';
        btn.disabled = true;

        html2pdf().set(opt).from(element).save().then(() => {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }).catch(err => {
            console.error(err);
            alert("Lỗi khi xuất PDF");
            btn.innerHTML = oldText;
            btn.disabled = false;
        });
    };

    function confirmRefreshChecklist() {
        if (confirm('Làm mới kỳ mới? Toàn bộ trạng thái và ghi chú sẽ bị xóa.')) {
            refreshChecklist();
        }
    }

    async function refreshChecklist() {
        if (!currentChecklistData || !currentEmployeeId) return;
        currentChecklistData.tasks.forEach(task => {
            task.status = 'not-started';
            task.notes = '';
            task.weeklyPlan = null;
        });
        try {
            await saveTasks();
            renderTasks(currentChecklistData.tasks);
            alert('Đã làm mới checklist thành công!');
        } catch (error) {
            console.error("Lỗi khi làm mới:", error);
            alert("Làm mới thất bại.");
        }
    }
    </script>
</body>
</html>
